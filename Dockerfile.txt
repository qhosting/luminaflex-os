# LUMINAFLEX OS | DOCKERFILE PRODUCTION (MIRROR)
# NODO: AURUM_CORE_V2
# PROTOCOLO: 741 8 520 | TU_SISTEMA_OPERATIVO

FROM node:20-alpine AS build-stage

WORKDIR /app

# 1. Copiamos manifiestos primero para optimizar la caché de capas de Docker
COPY package*.json ./

# 2. Instalamos todas las dependencias (necesario para tener 'tsc' y 'vite' en el path)
RUN npm install

# 3. Transferimos el resto de Tu Código al contenedor
COPY . .

# 4. Inyección de Variables de Entorno desde Tu Panel de Control
ARG API_KEY
ARG DATABASE_URL
ENV API_KEY=$API_KEY
ENV DATABASE_URL=$DATABASE_URL

# 5. Ejecución del Build Industrial
RUN npm run build

# Stage de Producción: Servidor de Alta Disponibilidad
FROM nginx:stable-alpine
COPY --from=build-stage /app/dist /usr/share/nginx/html

# 6. Sincronización de Tu Configuración Nginx Aurum
COPY nginx.conf /etc/nginx/conf.d/default.conf

HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:3000/ || exit 1

EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]